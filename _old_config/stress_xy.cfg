# XY Stress Test (детерминированный, без случайностей)
# Параметры вызова:
#   STRESS_XY V=9000 R=3 X=7 Y=110
#   V — базовая скорость перемещения (мм/мин), R — число проходов, X/Y — стартовая точка
[gcode_macro STRESS_XY]
description: Deterministic XY stress test with diagonal entries/exits
variable_xmin: 0.0
variable_ymin: 0.0
variable_xmax: 0.0
variable_ymax: 0.0
gcode:
  {% set cfg = printer.configfile.config %}
  {% set XMAX = cfg["stepper_x"]["position_max"]|float %}
  {% set YMAX = cfg["stepper_y"]["position_max"]|float %}
  {% set X0 = params.X|default(7)|float %}
  {% set Y0 = params.Y|default(110)|float %}
  {% set V  = params.V|default(9000)|float %}
  {% set R  = params.R|default(3)|int %}

  # Сохраним границы внутрь макроса (инфо-переменные)
  SET_GCODE_VARIABLE MACRO=STRESS_XY VARIABLE=xmin VALUE=0.0
  SET_GCODE_VARIABLE MACRO=STRESS_XY VARIABLE=ymin VALUE=0.0
  SET_GCODE_VARIABLE MACRO=STRESS_XY VARIABLE=xmax VALUE={XMAX}
  SET_GCODE_VARIABLE MACRO=STRESS_XY VARIABLE=ymax VALUE={YMAX}

  G90
  M83
  ; начальная точка
  G1 X{X0} Y{Y0} F{V}

  {% for i in range(R) %}
    ; ===== Проход {{i+1}} из {{R}} — периметры по краям со входом/выходом по диагонали =====
    ; базовый периметр (по часовой)
    G1 X{X0}   Y{YMAX} F{V}
    G1 X{XMAX} Y{YMAX} F{V*1.2}
    G1 X{XMAX} Y{Y0}   F{V*1.2}
    G1 X{X0}   Y{Y0}   F{V}

    ; диагонали (стресс на смену направления)
    G1 X{XMAX} Y{YMAX} F{V*1.5}
    G1 X{X0}   Y{Y0}   F{V*1.5}
    G1 X{XMAX} Y{Y0}   F{V*1.6}
    G1 X{X0}   Y{YMAX} F{V*1.6}

    ; мелкие «дёрганья» у углов (вход/выход под углом)
    G1 X{X0+10}    Y{Y0+10}    F{V}
    G1 X{X0}       Y{Y0}       F{V}
    G1 X{XMAX-10}  Y{YMAX-10}  F{V}
    G1 X{XMAX}     Y{YMAX}     F{V}

    ; зигзаги по X
    G1 X{X0+15}  Y{YMAX-15} F{V*1.2}
    G1 X{XMAX-15} Y{YMAX-15} F{V*1.2}
    G1 X{X0+15}  Y{YMAX-15} F{V*1.2}
    G1 X{XMAX-15} Y{YMAX-15} F{V*1.2}

    ; зигзаги по Y
    G1 X{XMAX-15} Y{Y0+15}  F{V*1.2}
    G1 X{XMAX-15} Y{YMAX-15} F{V*1.2}
    G1 X{XMAX-15} Y{Y0+15}  F{V*1.2}
    G1 X{XMAX-15} Y{YMAX-15} F{V*1.2}

    ; возврат к старту для следующего цикла
    G1 X{X0} Y{Y0} F{V}
  {% endfor %}