# XY Stress utilities leveraging shared GLOBAL_VARS defaults

[gcode_macro STRESS_XY]
description: Deterministic XY stress test with diagonal entries/exits
variable_xmin: 0.0
variable_ymin: 0.0
variable_xmax: 0.0
variable_ymax: 0.0
gcode:
  {% set vars = printer['gcode_macro GLOBAL_VARS'] %}
  {% set bed_x = vars.variable_bed_x|float %}
  {% set bed_y = vars.variable_bed_y|float %}
  {% set margin = params.MARGIN|default(0.0)|float %}
  {% set xmin = 0.0 + margin %}
  {% set ymin = 0.0 + margin %}
  {% set xmax = bed_x - margin %}
  {% set ymax = bed_y - margin %}
  {% set X0 = params.X|default(7)|float %}
  {% set Y0 = params.Y|default(bed_y - 10)|float %}
  {% set V = params.V|default(vars.variable_stress_speed)|float %}
  {% set R = params.R|default(3)|int %}

  SET_GCODE_VARIABLE MACRO=STRESS_XY VARIABLE=xmin VALUE={xmin}
  SET_GCODE_VARIABLE MACRO=STRESS_XY VARIABLE=ymin VALUE={ymin}
  SET_GCODE_VARIABLE MACRO=STRESS_XY VARIABLE=xmax VALUE={xmax}
  SET_GCODE_VARIABLE MACRO=STRESS_XY VARIABLE=ymax VALUE={ymax}

  G90
  M83
  G1 X{X0} Y{Y0} F{V}

  {% for i in range(R) %}
    ; Pass {{i+1}} of {{R}}
    G1 X{xmin}   Y{ymax} F{V}
    G1 X{xmax} Y{ymax} F{V*1.2}
    G1 X{xmax} Y{ymin}   F{V*1.2}
    G1 X{xmin}   Y{ymin}   F{V}

    G1 X{xmax} Y{ymax} F{V*1.5}
    G1 X{xmin}   Y{ymin}   F{V*1.5}
    G1 X{xmax} Y{ymin}   F{V*1.6}
    G1 X{xmin}   Y{ymax} F{V*1.6}

    G1 X{xmin+10}    Y{ymin+10}    F{V}
    G1 X{xmin}       Y{ymin}       F{V}
    G1 X{xmax-10}  Y{ymax-10}  F{V}
    G1 X{xmax}     Y{ymax}     F{V}

    G1 X{xmin+15}  Y{ymax-15} F{V*1.2}
    G1 X{xmax-15} Y{ymax-15} F{V*1.2}
    G1 X{xmin+15}  Y{ymax-15} F{V*1.2}
    G1 X{xmax-15} Y{ymax-15} F{V*1.2}

    G1 X{xmax-15} Y{ymin+15}  F{V*1.2}
    G1 X{xmax-15} Y{ymax-15} F{V*1.2}
    G1 X{xmax-15} Y{ymin+15}  F{V*1.2}
    G1 X{xmax-15} Y{ymax-15} F{V*1.2}

    G1 X{X0} Y{Y0} F{V}
  {% endfor %}

[gcode_macro STRESS_XY_PLUS]
description: XY stress with arcs, stadiums and diagonals
gcode:
  {% set vars = printer['gcode_macro GLOBAL_VARS'] %}
  {% set bed_x = vars.variable_bed_x|float %}
  {% set bed_y = vars.variable_bed_y|float %}
  {% set margin = params.MARGIN|default(vars.variable_stress_margin)|float %}
  {% set xmin = 0.0 + margin %}
  {% set ymin = 0.0 + margin %}
  {% set xmax = bed_x - margin %}
  {% set ymax = bed_y - margin %}
  {% set X0   = params.X|default(7)|float %}
  {% set Y0   = params.Y|default(bed_y - margin - 5)|float %}
  {% set V    = params.V|default(vars.variable_stress_speed_plus)|float %}
  {% set RPT  = params.R|default(3)|int %}
  {% set RAD  = params.RAD|default(vars.variable_stress_corner_radius)|float %}
  {% set STAD_L = params.STAD_L|default(vars.variable_stress_stad_length)|float %}
  {% set STAD_R = params.STAD_R|default(vars.variable_stress_stad_radius)|float %}

  {% set max_stad_l = (xmax - xmin) - 2*STAD_R %}
  {% if STAD_L > max_stad_l %}
    {% set STAD_L = max_stad_l %}
  {% endif %}

  {% set cx = bed_x/2.0 %}
  {% set cy = bed_y/2.0 %}

  G90
  M83
  G1 X{X0} Y{Y0} F{V}

  {% for i in range(RPT) %}
    ; Cycle {{i+1}} of {{RPT}}
    G1 X{xmin} Y{ymin} F{V}
    G1 X{xmin} Y{ymax} F{V}
    G1 X{xmax} Y{ymax} F{V*1.2}
    G1 X{xmax} Y{ymin} F{V*1.2}
    G1 X{xmin} Y{ymin} F{V}

    G1 X{xmax} Y{ymax} F{V*1.5}
    G1 X{xmin} Y{ymin} F{V*1.5}
    G1 X{xmax} Y{ymin} F{V*1.6}
    G1 X{xmin} Y{ymax} F{V*1.6}

    G0 X{xmin+RAD} Y{ymin} F{V}
    G2 X{xmin-RAD} Y{ymin} I{-RAD} J{0} F{V}
    G2 X{xmin+RAD} Y{ymin} I{RAD}  J{0} F{V}

    G0 X{xmax-RAD} Y{ymin} F{V}
    G2 X{xmax+RAD} Y{ymin} I{RAD}  J{0} F{V}
    G2 X{xmax-RAD} Y{ymin} I{-RAD} J{0} F{V}

    G0 X{xmax-RAD} Y{ymax} F{V}
    G2 X{xmax+RAD} Y{ymax} I{RAD}  J{0} F{V}
    G2 X{xmax-RAD} Y{ymax} I{-RAD} J{0} F{V}

    G0 X{xmin+RAD} Y{ymax} F{V}
    G2 X{xmin-RAD} Y{ymax} I{-RAD} J{0} F{V}
    G2 X{xmin+RAD} Y{ymax} I{RAD}  J{0} F{V}

    {% set L2 = STAD_L/2.0 %}
    G0 X{cx - L2} Y{cy + STAD_R} F{V}
    G1 X{cx + L2} Y{cy + STAD_R} F{V*1.3}
    G2 X{cx + L2} Y{cy - STAD_R} I{0} J{-STAD_R} F{V*1.3}
    G1 X{cx - L2} Y{cy - STAD_R} F{V*1.3}
    G2 X{cx - L2} Y{cy + STAD_R} I{0} J{STAD_R} F{V*1.3}

    {% set L2y = ((ymax - ymin) - 2*STAD_R)/2.0 %}
    {% if L2y < 5 %}
      {% set L2y = 5 %}
    {% endif %}
    G0 X{cx - STAD_R} Y{cy + L2y} F{V}
    G1 X{cx - STAD_R} Y{cy - L2y} F{V*1.3}
    G2 X{cx + STAD_R} Y{cy - L2y} I{STAD_R} J{0} F{V*1.3}
    G1 X{cx + STAD_R} Y{cy + L2y} F{V*1.3}
    G2 X{cx - STAD_R} Y{cy + L2y} I{-STAD_R} J{0} F{V*1.3}

    G0 X{xmin+8}  Y{ymax-8} F{V}
    G1 X{xmax-8}  Y{ymax-8}  F{V*1.4}
    G1 X{xmin+8}  Y{ymax-12} F{V*1.4}
    G1 X{xmax-8}  Y{ymax-12} F{V*1.4}
    G1 X{xmin+8}  Y{ymax-16} F{V*1.4}
    G1 X{xmax-8}  Y{ymax-16} F{V*1.4}

    G0 X{xmax-8} Y{ymin+8} F{V}
    G1 X{xmax-8} Y{ymax-8}  F{V*1.4}
    G1 X{xmax-12} Y{ymin+8} F{V*1.4}
    G1 X{xmax-12} Y{ymax-8} F{V*1.4}
    G1 X{xmax-16} Y{ymin+8} F{V*1.4}
    G1 X{xmax-16} Y{ymax-8} F{V*1.4}

    G1 X{xmin+10} Y{ymin+10} F{V}
    G1 X{xmin}    Y{ymin}    F{V}
    G1 X{xmax-10} Y{ymin+10} F{V}
    G1 X{xmax}    Y{ymin}    F{V}
    G1 X{xmax-10} Y{ymax-10} F{V}
    G1 X{xmax}    Y{ymax}    F{V}
    G1 X{xmin+10} Y{ymax-10} F{V}
    G1 X{xmin}    Y{ymax}    F{V}

    G1 X{X0} Y{Y0} F{V*1.6}
  {% endfor %}
